DATA:
  dataset: qata_covid19_integrated
  data_root: /root/DETRIS_SAM/QaTa
  use_augmentation: true
  aug_probability: 0.6                    # 适中的增强概率，避免破坏医学图像
  return_detris_format: true              # 是否同时返回DETRIS格式数据
  enable_point_prompts: true             
  max_points_per_sample: 1                # 每个样本最大点数

# DETRIS相关配置（用于构建DETRIS模型）
DETRIS:
  # 适配器配置
  visual_adapter_dim: 128
  visual_adapter_layer: [1,3,5,7,9,11]
  txt_adapter_dim: 64
  txtual_adapter_layer: [1,3,5,7,9,11]
  
  # 模型配置
  cxr_bert_model: "/root/DETRIS_SAM/BiomedVLP-CXR-BERT-specialized"
  dino_pretrain: pretrain/backbone_compatible.safetensors
  dino_layers: 12
  output_dinov2: [4, 8]
  model_name: CXR-BERT-b-16
  dino_name: RAD-DINO
  
  # DETRIS输入配置
  detris_size: 518                        # DETRIS输入尺寸
  input_size: 518                         # 别名，确保兼容性
  word_len: 77
  word_dim: 512
  
  # 网络结构配置
  ladder_dim: 128
  nhead: 8
  multi_stage: 3
  stride: [1, 1, 1]
  vis_dim: 512
  fpn_in: [768, 768, 768]
  fpn_out: [256, 512, 1024]
  
  # 解码器配置
  num_layers: 3
  num_head: 8
  dim_ffn: 512
  dropout: 0.1
  intermediate: False
  
  # CoCoOp配置
  use_cocoop: true
  n_ctx: 4
  adapter_scale: 0.2
  meta_net_hidden_dim: 48
  conditional_weight: 1.0
  cocoop_debug: false
  cocoop_early_fusion: false
  cocoop_feature_layers: [3, 6, 9]
  normalize_visual_condition: false
  use_layer_attention: false
  
  # 对比学习配置
  use_contrastive: true
  contrastive_temperature: 0.07
  use_dynamic_weights: true
  total_epochs: 50                        # 用于动态权重计算

  freeze_encoder: true                    # 冻结DETRIS encoder
  freeze_decoder: false                   # 解冻DETRIS decoder进行训练
  freeze_backbone: true                   # 冻结DETRIS backbone
  detris_decoder_lr: 0.00005

# SAM相关配置 - 修改为256尺寸以匹配权重文件
SAM:
  sam_model_type: "vit_b"                 # SAM模型类型: vit_b, vit_l, vit_h
  
  # 权重路径配置 - SAM-Med2D权重(256尺寸)
  sam_checkpoint: "/root/DETRIS_SAM/pretrain/sam-med2d_b.pth"  # SAM-Med2D权重(256尺寸)
  use_med_weights: true                   # 使用医学专用权重
  
  # SAM模型配置 - 修改为256尺寸匹配权重文件
  image_size: 256                         # 修改为256以匹配SAM-Med2D权重文件
  encoder_adapter: true                   # 是否使用encoder adapter
  
  # 像素标准化参数
  sam_pixel_mean: [123.675, 116.28, 103.53]
  sam_pixel_std: [58.395, 57.12, 57.375]
  
  # 学习率配置 - 针对不同组件
  sam_mask_decoder_lr: 0.0001             # SAM Mask Decoder学习率
  sam_prompt_encoder_lr: 0.00005          # SAM Prompt Encoder学习率
  sam_image_encoder_lr: 0.00001           # SAM Image Encoder学习率
  sam_adapter_lr: 0.0001                  # SAM Adapter学习率

# 集成模型配置
INTEGRATED:
  detris_pretrained: "/root/DETRIS_SAM/pretrain/epoch_021_iou_0.7156.pth"  # DETRIS预训练权重路径
  
  # 训练组件配置 - 适配新SAM架构
  trainable_components: ['detris_decoder', 'prompt_encoder', 'mask_decoder']  # 可训练的组件
                # 只训练mask_decoder
  
  # Bridge配置 - 调整target_size以匹配256尺寸SAM
  bridge_type: "default"                  # Bridge类型: default, simple, refined
  bridge_lr: 0.0001                       # Bridge学习率（如果bridge有参数）
  bridge_use_refinement: false            # 是否使用可学习的refinement层
  bridge_apply_threshold: false           # 是否应用阈值化
  
  # 点采样器配置
  point_sampler_temperature: 1.0          # Gumbel采样温度
  point_sampler_hard: false               # 是否使用硬采样
  point_sampler_min_confidence: 0.8       # 最小置信度阈值
  
  # 新SAM相关配置
  use_new_sam_interface: true             # 使用新SAM接口
  batch_processing_mode: "sequential"     # 批处理模式: sequential(逐个处理) 或 parallel(并行，如果支持)
  
  # 训练策略（已废弃的旧配置，保留兼容性）
  freeze_detris: true                     # 是否冻结DETRIS参数
  freeze_sam_backbone: false             # 是否冻结SAM骨干网络
  freeze_sam_prompt_encoder: false       # 是否冻结SAM提示编码器
  
  detris_training_config:
    freeze_encoder: true
    freeze_decoder: false
    freeze_backbone: true

# 训练配置 - 多组件Warmup + 余弦退火优化
TRAIN:
  # 基础训练设置
  epochs: 50
  start_epoch: 0
  batch_size: 8                           # 256尺寸可以用更大的batch size
  batch_size_val: 16                      # 验证batch size也可以更大
  workers: 2                              # 可以增加worker数
  
  # 多组件学习率调度器设置
  warmup_epochs: 5                        # Warmup轮数
  min_lr_ratio: 0.01                      # 最小学习率比例（最终LR = base_lr * min_lr_ratio）
  
  # 基础学习率（已废弃，使用SAM节中的具体学习率）
  base_lr: 0.0002                         # 保留兼容性
  
  # 优化器设置
  weight_decay: 0.0001                    # 权重衰减
  betas: [0.9, 0.999]                     # AdamW的beta参数
  eps: 0.00000001                         # AdamW的epsilon参数
  lr_multi: 1.0                           # DETRIS需要的学习率倍数参数
  
  # 显存和性能优化
  gradient_accumulation_steps: 1          # 梯度累积步数（自动计算）
  max_norm: 1.0                           # 梯度裁剪
  
  # 其他训练设置
  manual_seed: 42
  print_freq: 20
  save_freq: 5
  keep_checkpoints: 5                     # 保留的检查点数量
  
  # 实验设置
  exp_name: "Integrated_DETRIS_SAM_Med2D_256_NewInterface"  # 更新实验名称反映256尺寸
  output_folder: "/root/autodl-tmp/outputs_integrated"
  resume: ""                              # 恢复训练的检查点路径
  evaluate: false                         # 是否只进行评估

# 损失函数配置
LOSS:
  dice_weight: 0.5          # 从0.6降低到0.5
  boundary_weight: 0.3      # 保持0.3
  hausdorff_weight: 0.2     # 新增Hausdorff权重
  normalize_hausdorff: true 
  debug_loss_components: false   

  # Hausdorff损失新增配置
  hausdorff_sample_points: 1000
  hausdorff_reduction: "mean"
  hausdorff_boundary_threshold: 0.1
  use_simplified_triple: true

# 测试配置
TEST:
  test_split: "test"
  visualize: true                         # 是否保存可视化结果
  save_predictions: true                  # 是否保存预测结果
  prediction_format: "png"               # 预测结果格式: png, npy
  overlay_predictions: true               # 是否生成叠加可视化
  
  # 测试时的推理配置
  multimask_output: true                  # SAM是否输出多个mask
  enable_point_sampling_test: true       # 测试时是否启用点采样
  confidence_threshold: 0.5               # 置信度阈值
  
  # 新SAM测试配置
  use_single_interface: true              # 测试时使用单样本接口（性能更好）
  
  # 评估指标
  metrics: ["iou", "dice", "precision", "recall", "f1"]  # 评估指标
  save_metrics_per_image: true            # 是否保存每张图像的指标

# 验证配置 - 动态阈值搜索（新增）
VALIDATION:
  # 动态阈值搜索配置
  dynamic_threshold_batches: 5            # 前N个batch进行阈值搜索
  threshold_candidates: [0.05, 0.1, 0.15, 0.2, 0.25, 0.3, 0.35, 0.4, 0.45, 0.5, 0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9]  # 候选阈值列表
  
  # 阈值确定策略
  threshold_strategy: "average"           # 阈值确定策略: average(平均), weighted(加权平均), best(最佳单个)
  
  # 调试配置
  debug_first_batch: true                 # 是否打印第一个batch的详细调试信息
  log_threshold_details: true             # 是否记录阈值搜索的详细结果
  
  # 验证优化
  early_stopping_patience: 10             
  early_stopping_min_delta: 0.001         

# 其他配置 - 性能优化
MISC:
  amp: true                               # 启用混合精度训练
  deterministic: false                    # 是否使用确定性训练（False可启用TF32等优化）
  benchmark: true                         # 启用CUDNN benchmark
  sync_bn: false                          # 是否使用同步BN（分布式训练）
  
  # 内存和性能优化
  gradient_checkpointing: true            # 是否启用梯度检查点（节省显存）
  empty_cache_freq: 3                     # 清理显存的频率（每N个epoch）
  
  # 调试和监控
  debug_mode: false                       # 调试模式
  wandb_project: "integrated_detris_sam_med2d_256"  # 更新WandB项目名反映256尺寸
  wandb_enabled: false                    # 是否启用WandB日志
  
  # 性能监控配置
  monitor_gpu_memory: true                # 是否监控GPU显存使用
  log_model_info: true                    # 是否记录详细模型信息