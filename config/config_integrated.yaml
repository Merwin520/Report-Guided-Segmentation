# config_refactored_training.yaml
# 重构后模型的训练配置

DATA:
  dataset: qata_covid19_integrated
  data_root: /root/DETRIS_SAM/QaTa
  use_augmentation: true
  aug_probability: 0.75
  return_detris_format: true


DETRIS:
  # 适配器配置
  visual_adapter_dim: 128
  visual_adapter_layer: [1,3,5,7,9,11]
  txt_adapter_dim: 64
  txtual_adapter_layer: [1,3,5,7,9,11]
  
  # 模型配置
  cxr_bert_model: "/root/DETRIS_SAM/BiomedVLP-CXR-BERT-specialized"
  dino_pretrain: pretrain/backbone_compatible.safetensors
  dino_layers: 12
  output_dinov2: [4, 8]
  model_name: CXR-BERT-b-16
  dino_name: RAD-DINO
  
  # DETRIS输入配置
  detris_size: 518
  input_size: 518
  word_len: 77
  word_dim: 512
  
  # 网络结构配置
  ladder_dim: 128
  nhead: 8
  multi_stage: 3
  stride: [1, 1, 1]
  vis_dim: 512
  fpn_in: [768, 768, 768]
  fpn_out: [256, 512, 1024]
  
  # 解码器配置
  num_layers: 3
  num_head: 8
  dim_ffn: 512
  dropout: 0.1
  intermediate: false
  
  # CoCoOp配置
  use_cocoop: true
  n_ctx: 4
  adapter_scale: 0.2
  meta_net_hidden_dim: 48
  conditional_weight: 1.0
  cocoop_feature_layers: [3, 6, 9]
  
  # 对比学习配置
  use_contrastive: true
  contrastive_temperature: 0.07
  use_dynamic_weights: true
  total_epochs: 50

# SAM相关配置（保持不变）
SAM:
  sam_model_type: "vit_b"
  sam_checkpoint: "pretrain/sam_vit_b_01ec64.pth"
  medsam_checkpoint: "pretrain/medsam_vit_b.pth"
  use_medsam: true
  sam_size: 1024
  sam_pixel_mean: [123.675, 116.28, 103.53]
  sam_pixel_std: [58.395, 57.12, 57.375]

# 集成模型配置 - 核心修改部分
INTEGRATED:
  detris_pretrained: "/root/autodl-tmp/output/QaTa_Covid19_DETRIS_20250824_193218/epoch_025_iou_0.7216.pth"
  

  trainable_components_config:
    # DETRIS 组件
    detris_cocoop: false                    # CoCoOp相关组件
    detris_text_adapter: false              # DETRIS文本适配器
    detris_vision_adapter: false             # DETRIS视觉适配器  
    detris_text_encoder: false              # DETRIS文本编码器主体
    detris_vision_encoder: false            # DETRIS视觉编码器主体
    detris_fusion: false                    # DETRIS融合模块
    detris_neck: false                      # DETRIS neck
    detris_decoder: false                    # DETRIS解码器
    detris_projector: false                  # DETRIS投影层
    
    # SAM 组件
    sam_image_encoder: false                # SAM图像编码器主体
    sam_image_encoder_adapter: true         # SAM图像编码器适配器
    sam_image_encoder_patch: false          # SAM patch embedding
    sam_image_encoder_pos: false            # SAM位置编码
    sam_image_encoder_neck: false           # SAM neck
    sam_image_encoder_blocks: false         # SAM transformer blocks
    sam_prompt_encoder: true               # SAM提示编码器
    sam_mask_decoder: true                  # SAM掩码解码器
    
    # 其他组件
    bridge: false                           # Bridge（无可训练参数）
    point_sampler: false                   
    other: false                            # 未分类参数（通常冻结）
  

  component_learning_rates:
    #detris_cocoop: 0.00005

    # SAM 组件学习率
    sam_image_encoder_adapter: 0.0002       # 通用adapter学习率
    sam_mask_decoder: 0.0001
    sam_prompt_encoder: 0.0001
    
  
  # Bridge配置（简化，无可训练参数）
  bridge_type: "trainable"

  bridge_use_soft_dilation: false
  bridge_dilation_kernel_size: 3
  bridge_dilation_iterations: 2
  bridge_dilation_beta: 5.0
  bridge_dilation_strength: 1.0
  
  # 点采样器配置
  enable_point_prompts: true 
  point_sampler_temperature: 1.0
  point_sampler_hard: false
  point_sampler_min_confidence: 0.4
  max_points_per_sample: 1

  # Box采样配置
  enable_box_sampling: true
  box_sampler_type: 'cdf'
  box_quantile_low: 0.05
  box_quantile_high: 0.95
  box_sampler_temperature: 10.0
  box_sampler_min_confidence: 0.01

# 训练配置
TRAIN:
  # 基础训练设置
  epochs: 50
  start_epoch: 0
  batch_size: 4
  batch_size_val: 8
  workers: 1
  
  # 早停配置
  early_stopping_patience: 10
  early_stopping_min_delta: 0.0001
  early_stopping_mode: 'max'
  early_stopping_metric: 'iou'
  early_stopping_restore_best_weights: true
  early_stopping_verbose: true
  early_stopping_save_best_model: true

  # 学习率调度设置
  warmup_epochs: 5
  min_lr_ratio: 0.01
  
  # 向后兼容配置（训练脚本日志显示需要）
  base_lr: 0.0001
  sam_mask_decoder_lr: 0.0001
  sam_adapter_lr: 0.0001
  
  # 优化器设置
  weight_decay: 0.0001
  betas: [0.9, 0.999]
  eps: 0.00000001
  
  # 性能优化
  gradient_accumulation_steps: 1
  max_norm: 1.0
  
  # 其他训练设置
  manual_seed: 42
  print_freq: 20
  save_freq: 5
  keep_checkpoints: 5
  
  # 实验设置
  exp_name: "Refactored_DETRIS_SAM"
  output_folder: "/root/autodl-tmp/outputs_integrated"
  resume: ""
  evaluate: false

# 损失函数配置（保持不变）
LOSS:
  dice_weight: 0.3
  focal_weight: 0.3
  boundary_weight: 0.4
  
  dice_smooth: 0.00001
  
  focal_alpha: 1.0
  focal_gamma: 2.0
  
  boundary_alpha: 1.0
  normalize_boundary: true
  boundary_reduction: "mean"

  use_dynamic_weights: true
  total_epochs: 50
  
  weight_stages:
    - progress_percent: 30
      weights:
        dice: 0.6
        focal: 0.3
        boundary: 0.1
    - progress_percent: 60
      weights:
        dice: 0.4
        focal: 0.3
        boundary: 0.3
    - progress_percent: 100
      weights:
        dice: 0.3
        focal: 0.3
        boundary: 0.4

# 测试配置（保持不变）
TEST:
  test_split: "test"
  visualize: true
  save_predictions: true
  prediction_format: "png"
  overlay_predictions: true
  
  multimask_output: true
  enable_point_sampling_test: true
  confidence_threshold: 0.5
  
  metrics: ["iou", "dice", "precision", "recall", "f1"]
  save_metrics_per_image: false

# 验证配置（保持不变）
VALIDATION:
  dynamic_threshold_batches: 5
  threshold_candidates: [0.05, 0.1, 0.15, 0.2, 0.25, 0.3, 0.35, 0.4, 0.45, 0.5, 0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9]
  threshold_strategy: "average"
  debug_first_batch: true
  log_threshold_details: true

# 其他配置（保持不变）
MISC:
  amp: true
  deterministic: false
  benchmark: true
  gradient_checkpointing: true
  empty_cache_freq: 3
  monitor_gpu_memory: true
  log_model_info: true
